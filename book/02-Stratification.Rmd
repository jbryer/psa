---
editor_options: 
  chunk_output_type: console
---

# Stratification {#chapter-stratification}

Since in most cases this is a binary outcome, logistic regression is a common approach to estimating propensity scores. 

$$ \sigma =\frac { { e }^{ t } }{ { e }^{ t }+1 } =\frac { 1 }{ 1+{ e }^{ -1 } }  $$

$$ t={ \beta  }+{ \beta  }_{ 1 }x+\cdots +{ \beta  }_{ k } $$

$$ F\left( x \right) =\frac { 1 }{ 1+{ e }^{ -\left( { \beta  }+{ \beta  }_{ 1 }x+\cdots +{ \beta  }_{ k } \right)  } } $$

The goal in phase one of PSA is to estimate the probability of being in the treatment. 
Figure \@ref(fig:introduction-logistic) depicts a fitted logistic regression along with a sample of matchs connected by the purple lines.^[The data in this figure are from the [`lalonde`](#lalonde) dataset that will be described at the end of this chapter.]

```{r introduction-logistic, echo=FALSE, fig.height=4, fig.cap='Propensity Scores from Logistic Regression with Sample of Matched Pairs'}
lalonde.lr <- glm(lalonde.formu, family=binomial, data=lalonde)
lalonde$ps <- fitted(lalonde.lr)
lalonde.match <- Match(Y=lalonde$re78, Tr=lalonde$treat, X=lalonde$ps, M=1);
lalonde.match.df <- data.frame(treated.ps=lalonde[lalonde.match$index.treated,]$ps,
						       control.ps=lalonde[lalonde.match$index.control,]$ps,
							   treated.y=1, control.y=0)
lalonde.match.df <- lalonde.match.df[order(lalonde.match.df$control.ps),]
rows <- (1:nrow(lalonde.match.df) - 1) %% floor(nrow(lalonde.match.df) / 5) == 0
ggplot(lalonde, aes(x=ps, y=treat)) + geom_point(alpha=0.5) +
	stat_smooth(method="glm", method.args=list(family="binomial"), se=FALSE) +
	xlim(c(0,1)) + xlab('Propensity Score') + ylab('Treatment') +
	geom_segment(data=lalonde.match.df[rows,], 
				 aes(x=treated.ps, xend=control.ps, y=treated.y, yend=control.y),
				 color='purple')
```


The tutoring example has treatment with three levels: Treat1, Treat2, and Control. We'll convert this to a two level treatment for this example. 

```{r}
data(lalonde, package = 'Matching')
```

## Estimating Propensity Scores

```{r}
lalonde.formu <- treat ~ age + educ + black + hisp + married + nodegr + re74 + re75
lalonde.glm <- glm(lalonde.formu, 
				   family = binomial(link = 'logit'), 
				   data = lalonde)
summary(lalonde.glm)
```


```{r}
lalonde$ps <- fitted(lalonde.glm)
```

Check the distributions of propensity scores to ensure we have good overlap

```{r, , fig.height = 4}
ggplot(lalonde, aes(x = ps, color = as.logical(treat))) + 
	geom_density() +
	scale_color_brewer('Treatment', type = 'qual', palette = 6)
```

## Stratifying

Stratification using quintiles.

```{r}
breaks <- quantile(lalonde$ps, seq(0, 1, 1/5))
lalonde$strata <- cut(x = lalonde$ps, 
					  breaks = breaks, 
					  include.lowest = TRUE, 
					  labels = letters[1:(length(breaks) - 1)])
table(lalonde$strata, useNA = 'ifany')
table(lalonde$treat, lalonde$strata, useNA = 'ifany')
```

```{r, echo = FALSE, fig.height = 4}
text_labels <- data.frame(
	x =  breaks[-length(breaks)],
	y = 1,
	label = LETTERS[1:(length(breaks) - 1)]
)
ggplot() +
	geom_vline(xintercept = breaks) +
	geom_point(data = lalonde, aes(x = ps, y = log(re78 + 1), color = as.logical(treat)), alpha = 0.5) +
	geom_text(data = text_labels, aes(x = x, y = y, label = label), color = 'black', hjust = -1) +
	scale_color_brewer('Treatment', type = 'qual', palette = 6)
```


## Checking Balance

```{r}
covars <- all.vars(lalonde.formu)
covars <- lalonde[,covars[2:length(covars)]]
PSAgraphics::cv.bal.psa(covariates = covars, 
						treatment = lalonde$treat,
						propensity = lalonde$ps,
						strata = lalonde$strata)
```



```{r}
PSAgraphics::box.psa(continuous = lalonde$age, 
					 treatment = lalonde$treat, 
					 strata = lalonde$strata,
					 xlab = "Strata", 
					 balance = FALSE)
```


```{r, results = 'hide'}
PSAgraphics::cat.psa(categorical = lalonde$nodegr, 
					 treatment = lalonde$treat, 
					 strata = lalonde$strata, 
					 xlab = 'Strata',
					 balance = FALSE)
```

## Estimate Effects

```{r}
psa::loess.plot(x = lalonde$ps,
				response = log(lalonde$re78 + 1),
				treatment = lalonde$treat == 1)
```


```{r}
PSAgraphics::circ.psa(response = log(lalonde$re78 + 1), 
					  treatment = lalonde$treat == 1, 
					  strata = lalonde$strata, 
					  revc = TRUE)
```
