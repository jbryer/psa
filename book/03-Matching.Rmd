# Matching {#chapter-matching}

```{r}
lalonde.glm <- glm(lalonde.formu, family=binomial, data=lalonde)
ps <- fitted(lalonde.glm)  # Propensity scores
Y  <- lalonde$re78  # Dependent variable, real earnings in 1978
Tr <- lalonde$treat # Treatment indicator

```



```{r}
## Matching
# one-to-one matching with replacement (the "M=1" option).
# Estimating the treatment effect on the treated (default is ATT).
rr.att <- Match(Y = Y, 
				Tr = Tr, 
				X = ps,
				M = 1,
				estimand='ATT')
summary(rr.att) # The default estimate is ATT here
ls(rr.att)

rr.ate <- Match(Y=Y, Tr=Tr, X=ps, M=1, estimand='ATE')
summary(rr.ate)
ls(rr.ate)
```



```{r}
rr2 <- Match(Y = Y,
			 Tr = Tr,
			 X = ps,
			 M = 1, 
			 ties = TRUE, 
			 replace = TRUE,
			 estimand = 'ATT')
summary(rr2) # The default estimate is ATT here
length(unique(rr2$index.control))
ls(rr2)
```



```{r}
## Using the Matchit package
matchit.out <- matchit(lalonde.formu, data=lalonde)
summary(matchit.out)

# Same as above but calculate average treatment effect
rr.ate <- Match(Y=Y, Tr=Tr, X=ps, M=1, ties=FALSE, replace=FALSE, estimand='ATE')
summary(rr.ate) # Here the estimate is ATE

## Genetic Matching
rr.gen <- GenMatch(Tr=Tr, X=ps, 
				   BalanceMatrix=lalonde[,all.vars(lalonde.formu)[-1]],
				   estimand='ATE', M=1, pop.size=16)
rr.gen.mout <- Match(Y=Y, Tr=Tr, X=ps, estimand='ATE', Weight.matrix=rr.gen)
summary(rr.gen.mout)

## Partial exact matching
rr2 <- Matchby(Y=Y, Tr=Tr, X=ps, by=factor(lalonde$nodegr))
summary(rr2)

## Partial exact matching on two covariates
rr3 <- Matchby(Y=Y, Tr=Tr, X=ps, by=lalonde[,c('nodegr','married')])
summary(rr3)
```


