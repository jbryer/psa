<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 2 Stratification | Applied Propensity Score Analysis with R</title>
<meta name="author" content="Jason Bryer, Ph.D.">
<meta name="description" content="stratifyverb: stratify; 3rd person present: stratifies; past tense: stratified; past participle: stratified; gerund or present participle: stratifying 1. arrange or classify. 2. form or arrange...">
<meta name="generator" content="bookdown 0.36 with bs4_book()">
<meta property="og:title" content="Chapter 2 Stratification | Applied Propensity Score Analysis with R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://psa.bryer.org/chapter-stratification.html">
<meta property="og:image" content="https://psa.bryer.org/images/cover.png">
<meta property="og:description" content="stratifyverb: stratify; 3rd person present: stratifies; past tense: stratified; past participle: stratified; gerund or present participle: stratifying 1. arrange or classify. 2. form or arrange...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 2 Stratification | Applied Propensity Score Analysis with R">
<meta name="twitter:description" content="stratifyverb: stratify; 3rd person present: stratifies; past tense: stratified; past participle: stratified; gerund or present participle: stratifying 1. arrange or classify. 2. form or arrange...">
<meta name="twitter:image" content="https://psa.bryer.org/images/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.1/transition.js"></script><script src="libs/bs3compat-0.5.1/tabs.js"></script><script src="libs/bs3compat-0.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Applied Propensity Score Analysis with R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="chapter-introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="active" href="chapter-stratification.html"><span class="header-section-number">2</span> Stratification</a></li>
<li><a class="" href="chapter-matching.html"><span class="header-section-number">3</span> Matching</a></li>
<li><a class="" href="chapter-weighting.html"><span class="header-section-number">4</span> Weighting</a></li>
<li><a class="" href="chapter-sensitivity.html"><span class="header-section-number">5</span> Sensitivity Analysis</a></li>
<li><a class="" href="chapter-bootstrapping.html"><span class="header-section-number">6</span> Bootstrapping</a></li>
<li><a class="" href="chapter-missing.html"><span class="header-section-number">7</span> Missing Data</a></li>
<li><a class="" href="chapter-non-binary.html"><span class="header-section-number">8</span> Non-Binary Treatments</a></li>
<li><a class="" href="chapter-multilevelpsa.html"><span class="header-section-number">9</span> Multilevel PSA</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="appendix-shiny.html"><span class="header-section-number">A</span> Shiny Applications</a></li>
<li><a class="" href="appendix-psranges.html"><span class="header-section-number">B</span> Propensity Score Ranges</a></li>
<li><a class="" href="appendix-psmodels.html"><span class="header-section-number">C</span> Methods for Estimating Propensity Scores</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/jbryer/psa">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="chapter-stratification" class="section level1" number="2">
<h1>
<span class="header-section-number">2</span> Stratification<a class="anchor" aria-label="anchor" href="#chapter-stratification"><i class="fas fa-link"></i></a>
</h1>
<div class="rmdtip">
<p><strong>stratify</strong><br><em>verb: stratify; 3rd person present: stratifies; past tense: stratified; past participle: stratified; gerund or present participle: stratifying</em><br>
1. arrange or classify.<br>
2. form or arrange into strata.</p>
</div>
<p>Propensity score stratification leverages propensity scores so we can define strata (or groups) that roughly equivalent on all the observed covariates. Although it is reasonable to start with chapter <a href="chapter-matching.html#chapter-matching">3</a> on matching, stratification is an important method and even if you prefer to use a matching method, stratification will most often be used in order to evaluate balance.</p>
<div id="phase-i-estimate-propensity-scores-logistic-regression" class="section level2" number="2.1">
<h2>
<span class="header-section-number">2.1</span> Phase I: Estimate Propensity Scores (Logistic regression)<a class="anchor" aria-label="anchor" href="#phase-i-estimate-propensity-scores-logistic-regression"><i class="fas fa-link"></i></a>
</h2>
<p>To begin letâ€™s estimate propensity scores using logistic regression with the National Supported Work Demonostration (<code>lalonde</code>) dataset <span class="citation">(Lalonde 1986)</span>. Here, we are using the final model specification used by <span class="citation">Dehejia and Wahba (1999)</span>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">lalonde</span>, package <span class="op">=</span> <span class="st">'Matching'</span><span class="op">)</span></span>
<span><span class="va">lalonde_formu</span> <span class="op">&lt;-</span> <span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">age</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">educ</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">black</span> <span class="op">+</span></span>
<span>    <span class="va">hisp</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegr</span> <span class="op">+</span> <span class="va">re74</span>  <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">re74</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">re75</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">re75</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">lr_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">lalonde_formu</span>,</span>
<span>              data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>              family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'logit'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">lr_out</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = lalonde_formu, family = binomial(link = "logit"), 
##     data = lalonde)
## 
## Coefficients:
##               Estimate Std. Error z value Pr(&gt;|z|)  
## (Intercept)  4.008e+00  2.155e+00   1.860   0.0629 .
## age          1.372e-02  8.929e-02   0.154   0.8779  
## I(age^2)    -2.535e-04  1.472e-03  -0.172   0.8632  
## educ        -8.612e-01  4.154e-01  -2.073   0.0382 *
## I(educ^2)    4.482e-02  2.334e-02   1.920   0.0549 .
## black       -2.933e-01  3.679e-01  -0.797   0.4253  
## hisp        -9.472e-01  5.127e-01  -1.847   0.0647 .
## married      1.730e-01  2.826e-01   0.612   0.5404  
## nodegr      -4.280e-01  3.917e-01  -1.093   0.2745  
## re74         4.815e-06  5.689e-05   0.085   0.9326  
## I(re74^2)   -1.692e-09  1.999e-09  -0.846   0.3974  
## re75         1.273e-04  8.310e-05   1.532   0.1256  
## I(re75^2)   -4.623e-09  4.384e-09  -1.055   0.2916  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 604.20  on 444  degrees of freedom
## Residual deviance: 581.07  on 432  degrees of freedom
## AIC: 607.07
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lalonde</span><span class="op">$</span><span class="va">lr_ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">lr_out</span><span class="op">)</span></span></code></pre></div>
<p>Check the distributions of propensity scores to ensure we have good overlap</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">lalonde</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">lr_ps</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html">as.logical</a></span><span class="op">(</span><span class="va">treat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_density</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_color_manual</span><span class="op">(</span><span class="st">'Treatment'</span>, values <span class="op">=</span> <span class="va">palette2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">'Propensity Score'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-Stratification_files/figure-html/unnamed-chunk-4-1.png" width="100%" style="display: block; margin: auto;"></div>
<div id="stratifying" class="section level3" number="2.1.1">
<h3>
<span class="header-section-number">2.1.1</span> Stratifying<a class="anchor" aria-label="anchor" href="#stratifying"><i class="fas fa-link"></i></a>
</h3>
<p>Stratification using quintiles.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">breaks5</span> <span class="op">&lt;-</span> <span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/get_strata_breaks.html">get_strata_breaks</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">$</span><span class="va">lr_ps</span><span class="op">)</span></span>
<span><span class="va">breaks5</span></span></code></pre></div>
<pre><code>## $breaks
##         0%        20%        40%        60%        80%       100% 
## 0.08491513 0.34032233 0.35943734 0.40797660 0.51119006 0.83047510 
## 
## $labels
##     strata       xmin      xmax      xmid
## 0%       A 0.08491513 0.3403223 0.2126187
## 20%      B 0.34032233 0.3594373 0.3498798
## 40%      C 0.35943734 0.4079766 0.3837070
## 60%      D 0.40797660 0.5111901 0.4595833
## 80%      E 0.51119006 0.8304751 0.6708326</code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lalonde</span><span class="op">$</span><span class="va">lr_strata5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">lr_ps</span>, </span>
<span>                          breaks <span class="op">=</span> <span class="va">breaks5</span><span class="op">$</span><span class="va">breaks</span>, </span>
<span>                          include.lowest <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                          labels <span class="op">=</span> <span class="va">breaks5</span><span class="op">$</span><span class="va">labels</span><span class="op">$</span><span class="va">strata</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>, <span class="va">lalonde</span><span class="op">$</span><span class="va">lr_strata5</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    
##      A  B  C  D  E
##   0 66 61 51 42 40
##   1 23 28 38 47 49</code></pre>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-7"></span>
<img src="02-Stratification_files/figure-html/unnamed-chunk-7-1.png" alt="Distribution of propensity scores with strata breaks" width="100%"><p class="caption">
Figure 2.1: Distribution of propensity scores with strata breaks
</p>
</div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-8"></span>
<img src="02-Stratification_files/figure-html/unnamed-chunk-8-1.png" alt="Scatter plot of propensity scores and log of real earnings 1978 by treatment with strata breaks" width="100%"><p class="caption">
Figure 2.2: Scatter plot of propensity scores and log of real earnings 1978 by treatment with strata breaks
</p>
</div>
</div>
<div id="stratification-balance" class="section level3" number="2.1.2">
<h3>
<span class="header-section-number">2.1.2</span> Checking Balance<a class="anchor" aria-label="anchor" href="#stratification-balance"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">covars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/allnames.html">all.vars</a></span><span class="op">(</span><span class="va">lalonde.formu</span><span class="op">)</span></span>
<span><span class="va">covars</span> <span class="op">&lt;-</span> <span class="va">lalonde</span><span class="op">[</span>,<span class="va">covars</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu">PSAgraphics</span><span class="fu">::</span><span class="fu"><a href="https://jbryer.github.io/PSAgraphics/reference/cv.bal.psa.html">cv.bal.psa</a></span><span class="op">(</span>covariates <span class="op">=</span> <span class="va">covars</span>, </span>
<span>                        treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                        propensity <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">lr_ps</span>,</span>
<span>                        strata <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">lr_strata</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-Stratification_files/figure-html/unnamed-chunk-9-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">PSAgraphics</span><span class="fu">::</span><span class="fu"><a href="https://jbryer.github.io/PSAgraphics/reference/box.psa.html">box.psa</a></span><span class="op">(</span>continuous <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">age</span>, </span>
<span>                     treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>, </span>
<span>                     strata <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">lr_strata</span>,</span>
<span>                     xlab <span class="op">=</span> <span class="st">"Strata"</span>, </span>
<span>                     balance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-Stratification_files/figure-html/unnamed-chunk-10-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">PSAgraphics</span><span class="fu">::</span><span class="fu"><a href="https://jbryer.github.io/PSAgraphics/reference/cat.psa.html">cat.psa</a></span><span class="op">(</span>categorical <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">nodegr</span>, </span>
<span>                     treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>, </span>
<span>                     strata <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">lr_strata</span>, </span>
<span>                     xlab <span class="op">=</span> <span class="st">'Strata'</span>,</span>
<span>                     balance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-Stratification_files/figure-html/unnamed-chunk-11-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-12"></span>
<img src="02-Stratification_files/figure-html/unnamed-chunk-12-1.png" alt="Covariate balance plots for categorical variables" width="50%"><img src="02-Stratification_files/figure-html/unnamed-chunk-12-2.png" alt="Covariate balance plots for categorical variables" width="50%"><img src="02-Stratification_files/figure-html/unnamed-chunk-12-3.png" alt="Covariate balance plots for categorical variables" width="50%"><img src="02-Stratification_files/figure-html/unnamed-chunk-12-4.png" alt="Covariate balance plots for categorical variables" width="50%"><p class="caption">
Figure 2.3: Covariate balance plots for categorical variables
</p>
</div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-13"></span>
<img src="02-Stratification_files/figure-html/unnamed-chunk-13-1.png" alt="Covariate balance plots for numeric variables" width="50%"><img src="02-Stratification_files/figure-html/unnamed-chunk-13-2.png" alt="Covariate balance plots for numeric variables" width="50%"><img src="02-Stratification_files/figure-html/unnamed-chunk-13-3.png" alt="Covariate balance plots for numeric variables" width="50%"><img src="02-Stratification_files/figure-html/unnamed-chunk-13-4.png" alt="Covariate balance plots for numeric variables" width="50%"><p class="caption">
Figure 2.4: Covariate balance plots for numeric variables
</p>
</div>
</div>
</div>
<div id="phase-ii-estimate-effects" class="section level2" number="2.2">
<h2>
<span class="header-section-number">2.2</span> Phase II: Estimate Effects<a class="anchor" aria-label="anchor" href="#phase-ii-estimate-effects"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">PSAgraphics</span><span class="fu">::</span><span class="fu"><a href="https://jbryer.github.io/PSAgraphics/reference/loess.psa.html">loess.psa</a></span><span class="op">(</span>response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                       treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                       propensity <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">lr_ps</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-Stratification_files/figure-html/unnamed-chunk-14-1.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>## $ATE
## [1] 0.9008386
## 
## $se.wtd
## [1] 0.3913399
## 
## $CI95
## [1] 0.1181588 1.6835185
## 
## $summary.strata
##    counts.0 counts.1  means.0  means.1 diff.means
## 1        34       11 6.268705 6.474912  0.2062076
## 2        32       12 5.491717 5.659280  0.1675631
## 3        31       14 5.467712 5.703584  0.2358722
## 4        30       14 5.425593 5.747613  0.3220194
## 5        27       18 5.397146 5.831117  0.4339703
## 6        24       20 5.302660 6.339721  1.0370619
## 7        21       23 5.125331 6.607936  1.4826043
## 8        21       24 5.036908 6.594808  1.5578999
## 9        22       22 5.182703 6.981383  1.7986801
## 10       18       27 6.047529 7.820786  1.7732573</code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/loess_plot.html">loess_plot</a></span><span class="op">(</span>ps <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">lr_ps</span>,</span>
<span>                outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>,</span>
<span>                responseTitle <span class="op">=</span> <span class="st">'log(re78)'</span>,</span>
<span>                plot.strata <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                points.treat.alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                points.control.alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                percentPoints.treat <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                percentPoints.control <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                se <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                method <span class="op">=</span> <span class="st">'loess'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-Stratification_files/figure-html/unnamed-chunk-15-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">PSAgraphics</span><span class="fu">::</span><span class="fu"><a href="https://jbryer.github.io/PSAgraphics/reference/circ.psa.html">circ.psa</a></span><span class="op">(</span>response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>                      treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>, </span>
<span>                      strata <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">lr_strata5</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-Stratification_files/figure-html/unnamed-chunk-16-1.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>## $summary.strata
##   n.FALSE n.TRUE means.FALSE means.TRUE
## A      66     23    6.280406   6.600537
## B      61     28    4.409935   5.129193
## C      51     38    6.212981   6.455034
## D      42     47    4.705981   6.208840
## E      40     49    5.783529   7.576461
## 
## $wtd.Mn.FALSE
## [1] 5.478567
## 
## $wtd.Mn.TRUE
## [1] 6.394013
## 
## $ATE
## [1] 0.9154463
## 
## $se.wtd
## [1] 0.394155
## 
## $approx.t
## [1] 2.322554
## 
## $df
## [1] 435
## 
## $CI.95
## [1] 0.1407612 1.6901314</code></pre>
</div>
<div id="phase-iii-sensitivity-analysis-1" class="section level2" number="2.3">
<h2>
<span class="header-section-number">2.3</span> Phase III: Sensitivity Analysis<a class="anchor" aria-label="anchor" href="#phase-iii-sensitivity-analysis-1"><i class="fas fa-link"></i></a>
</h2>
<p>Now that we have established there is a statistically significant effect of the intervention after adjusting for the selection bias using propensity scores we will want to evaluate the robustness of that effect. Sensitivity analysis is one approach but it is only well defined for matching methods. In chapter <a href="chapter-bootstrapping.html#chapter-bootstrapping">6</a> we will introduce a bootstrapping method that can help test the robustness. But <span class="citation">Rosenbaum (2012)</span> suggest another approach to test the sensitivity is to test the null hypothesis twice. We will do that here using a classification tree approach to estimating propensity scores and strata.</p>
<div id="estimate-propensity-scores-classification-tree" class="section level3" number="2.3.1">
<h3>
<span class="header-section-number">2.3.1</span> Estimate Propensity Scores (classification tree)<a class="anchor" aria-label="anchor" href="#estimate-propensity-scores-classification-tree"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span></span>
<span><span class="va">tree_out</span> <span class="op">&lt;-</span> <span class="fu">tree</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tree/man/tree.html">tree</a></span><span class="op">(</span><span class="va">lalonde_formu</span>,</span>
<span>                       data <span class="op">=</span> <span class="va">lalonde</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">tree_out</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">tree_out</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="02-Stratification_files/figure-html/tree_plot-1.png" alt="Classification tree" width="100%"><p class="caption">
(#fig:tree_plot)Classification tree
</p>
</div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lalonde</span><span class="op">$</span><span class="va">tree_ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_out</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">$</span><span class="va">tree_ps</span>, <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>, useNA <span class="op">=</span> <span class="st">'ifany'</span><span class="op">)</span></span></code></pre></div>
<pre><code>##                    
##                       0   1
##   0.332             167  83
##   0.344827586206897  19  10
##   0.351851851851852  35  19
##   0.612903225806452  24  38
##   0.659090909090909  15  29
##   1                   0   6</code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lalonde</span><span class="op">$</span><span class="va">tree_strata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_out</span>, type <span class="op">=</span> <span class="st">'where'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">$</span><span class="va">tree_strata</span>, <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>, useNA <span class="op">=</span> <span class="st">'ifany'</span><span class="op">)</span></span></code></pre></div>
<pre><code>##     
##        0   1
##   3  167  83
##   5   15  29
##   6   35  19
##   9   24  38
##   10  19  10
##   11   0   6</code></pre>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="chapter-introduction.html"><span class="header-section-number">1</span> Introduction</a></div>
<div class="next"><a href="chapter-matching.html"><span class="header-section-number">3</span> Matching</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>In this chapter</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#chapter-stratification"><span class="header-section-number">2</span> Stratification</a></li>
<li>
<a class="nav-link" href="#phase-i-estimate-propensity-scores-logistic-regression"><span class="header-section-number">2.1</span> Phase I: Estimate Propensity Scores (Logistic regression)</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#stratifying"><span class="header-section-number">2.1.1</span> Stratifying</a></li>
<li><a class="nav-link" href="#stratification-balance"><span class="header-section-number">2.1.2</span> Checking Balance</a></li>
</ul>
</li>
<li><a class="nav-link" href="#phase-ii-estimate-effects"><span class="header-section-number">2.2</span> Phase II: Estimate Effects</a></li>
<li>
<a class="nav-link" href="#phase-iii-sensitivity-analysis-1"><span class="header-section-number">2.3</span> Phase III: Sensitivity Analysis</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#estimate-propensity-scores-classification-tree"><span class="header-section-number">2.3.1</span> Estimate Propensity Scores (classification tree)</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/jbryer/psa/blob/master/book/02-Stratification.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/jbryer/psa/edit/master/book/02-Stratification.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
      <div class="book-extra">
        <ul class="list-unstyled">
<li><a href="https://github.com/jbryer/psa/actions/workflows/bookdown.yaml"><img src="https://github.com/jbryer/psa/actions/workflows/bookdown.yaml/badge.svg" alt="Bookdown Status"></a></li>
          <li><a href="https://www.repostatus.org/#wip"><img src="https://www.repostatus.org/badges/latest/wip.svg" border="0" alt="Project Status: WIP - Initial development is in progress, but there has not yet been a stable, usable release suitable for the public."></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Applied Propensity Score Analysis with R</strong>" was written by Jason Bryer, Ph.D.. It was last built on 2023-10-23.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
