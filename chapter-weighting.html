<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 4 Weighting | Applied Propensity Score Analysis with R</title>
<meta name="author" content="Jason Bryer, Ph.D.">
<meta name="description" content="weightverb 1. hold (something) down by placing a heavy object on top of it. 2. attach importance or value to. Propensity score weighting is the approach to using propensity scores as weights in...">
<meta name="generator" content="bookdown 0.36 with bs4_book()">
<meta property="og:title" content="Chapter 4 Weighting | Applied Propensity Score Analysis with R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://psa.bryer.org/chapter-weighting.html">
<meta property="og:image" content="https://psa.bryer.org/images/cover.png">
<meta property="og:description" content="weightverb 1. hold (something) down by placing a heavy object on top of it. 2. attach importance or value to. Propensity score weighting is the approach to using propensity scores as weights in...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 4 Weighting | Applied Propensity Score Analysis with R">
<meta name="twitter:description" content="weightverb 1. hold (something) down by placing a heavy object on top of it. 2. attach importance or value to. Propensity score weighting is the approach to using propensity scores as weights in...">
<meta name="twitter:image" content="https://psa.bryer.org/images/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.1/transition.js"></script><script src="libs/bs3compat-0.5.1/tabs.js"></script><script src="libs/bs3compat-0.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Applied Propensity Score Analysis with R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="chapter-introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="chapter-stratification.html"><span class="header-section-number">2</span> Stratification</a></li>
<li><a class="" href="chapter-matching.html"><span class="header-section-number">3</span> Matching</a></li>
<li><a class="active" href="chapter-weighting.html"><span class="header-section-number">4</span> Weighting</a></li>
<li><a class="" href="chapter-sensitivity.html"><span class="header-section-number">5</span> Sensitivity Analysis</a></li>
<li><a class="" href="chapter-bootstrapping.html"><span class="header-section-number">6</span> Bootstrapping</a></li>
<li><a class="" href="chapter-missing.html"><span class="header-section-number">7</span> Missing Data</a></li>
<li><a class="" href="chapter-non-binary.html"><span class="header-section-number">8</span> Non-Binary Treatments</a></li>
<li><a class="" href="chapter-multilevelpsa.html"><span class="header-section-number">9</span> Multilevel PSA</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="appendix-shiny.html"><span class="header-section-number">A</span> Shiny Applications</a></li>
<li><a class="" href="appendix-psranges.html"><span class="header-section-number">B</span> Propensity Score Ranges</a></li>
<li><a class="" href="appendix-psmodels.html"><span class="header-section-number">C</span> Methods for Estimating Propensity Scores</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/jbryer/psa">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="chapter-weighting" class="section level1" number="4">
<h1>
<span class="header-section-number">4</span> Weighting<a class="anchor" aria-label="anchor" href="#chapter-weighting"><i class="fas fa-link"></i></a>
</h1>
<div class="rmdtip">
<p><strong>weight</strong><br><em>verb</em><br>
1. hold (something) down by placing a heavy object on top of it.<br>
2. attach importance or value to.</p>
</div>
<p>Propensity score weighting is the approach to using propensity scores as weights in other statistical models such as regression or ANOVA. Like stratification (see Chapter <a href="chapter-stratification.html#chapter-stratification">2</a>), propensity score weighting has the advantage of all observations. In section <a href="chapter-introduction.html#introduction-effects">1.3.2</a> we introduced four different treatment estimators. The histograms used to conceptually explain what observations are included, or not included, in their calculation used propensity score weights. In this chapter will discuss the mathematical details of how those weights are calculated and applied, include the R code to generate the estimates.</p>
<p>We will present a formula for each of the treatment effects we wish to estimate. These formulas define the weights. Once we have the weights we can use them in a statistical model or using the following formula to estimate the treatment effect.</p>
<p><span class="math display" id="eq:eqcalcte">\[\begin{equation}
\begin{aligned}
Treatment\ Effect = \frac{\sum Y_{i}Z_{i}w_{i}}{\sum Z_{i} w_{i}} - \frac{\sum Y_{i}(1 - Z_{i}) w_{i}}{\sum (1 - Z_{i}) w_{i} }
\end{aligned}
\tag{4.1}
\end{equation}\]</span></p>
<p>For equation <a href="chapter-weighting.html#eq:eqcalcte">(4.1)</a>, <span class="math inline">\(w\)</span> is the weight (as defined in the following sections), <span class="math inline">\(Z_i\)</span> is the treatment assignment such that <span class="math inline">\(Z = 1\)</span> is treatment and <span class="math inline">\(Z = 0\)</span> is control, and <span class="math inline">\(Y_i\)</span> is the outcome.</p>
<div id="estimate-propensity-scores" class="section level2" number="4.1">
<h2>
<span class="header-section-number">4.1</span> Estimate Propensity Scores<a class="anchor" aria-label="anchor" href="#estimate-propensity-scores"><i class="fas fa-link"></i></a>
</h2>
<p>To begin, we estimate the propensity scores, here using logistic regression.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"lalonde"</span>, package <span class="op">=</span> <span class="st">'Matching'</span><span class="op">)</span></span>
<span><span class="va">lr_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">lalonde.formu</span>,</span>
<span>              data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>              family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'logit'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lalonde</span><span class="op">$</span><span class="va">lr_ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">lr_out</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="checking-balance-1" class="section level2" number="4.2">
<h2>
<span class="header-section-number">4.2</span> Checking Balance<a class="anchor" aria-label="anchor" href="#checking-balance-1"><i class="fas fa-link"></i></a>
</h2>
<p>Checking balance for propensity score weighting is the same as stratification. Figure <a href="chapter-weighting.html#fig:weight-balance">4.1</a> is a multiple covariate balance assessment plot. See section <a href="chapter-stratification.html#stratification-balance">2.1.2</a> in the stratification chapter for more details on how you can check for balance for individual covariates.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">PSAgraphics</span><span class="fu">::</span><span class="fu"><a href="https://jbryer.github.io/PSAgraphics/reference/cv.bal.psa.html">cv.bal.psa</a></span><span class="op">(</span>covariates <span class="op">=</span> <span class="va">lalonde</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/allnames.html">all.vars</a></span><span class="op">(</span><span class="va">lalonde.formu</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                        treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                        propensity <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">lr_ps</span>,</span>
<span>                        strata <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:weight-balance"></span>
<img src="04-Weighting_files/figure-html/weight-balance-1.png" alt="Multiple covariate balance assessment plot for Lalonde data after estimating propensity scores with logistic regression" width="100%"><p class="caption">
Figure 4.1: Multiple covariate balance assessment plot for Lalonde data after estimating propensity scores with logistic regression
</p>
</div>
<p>There is one additional balance check that can be done with propensity score weights. We can run the propensity score estimation model with the estimated propensity score weights. This should result in all the covariates having a non-statistically significant effect on the treatment. We will explore the details for the four treatment effects discussed in the next section.</p>
</div>
<div id="average-treatment-effect-ate-1" class="section level2" number="4.3">
<h2>
<span class="header-section-number">4.3</span> Average Treatment Effect (ATE)<a class="anchor" aria-label="anchor" href="#average-treatment-effect-ate-1"><i class="fas fa-link"></i></a>
</h2>
<p><span class="math display" id="eq:eqatew">\[\begin{equation}
\begin{aligned}
w_{ATE} = \frac{Z_i}{\pi_i} + \frac{1 - Z_i}{1 - \pi_i}
\end{aligned}
\tag{4.2}
\end{equation}\]</span></p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ate_weights</span> <span class="op">&lt;-</span> <span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/calculate_ps_weights.html">calculate_ps_weights</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                                         ps <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">lr_ps</span>,                          </span>
<span>                                         estimand <span class="op">=</span> <span class="st">'ATE'</span><span class="op">)</span></span></code></pre></div>
<div id="check-balance-with-ate-weights" class="section level3" number="4.3.1">
<h3>
<span class="header-section-number">4.3.1</span> Check Balance with ATE Weights<a class="anchor" aria-label="anchor" href="#check-balance-with-ate-weights"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">lalonde.formu</span>,</span>
<span>    data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>    family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">quasibinomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'logit'</span><span class="op">)</span>,</span>
<span>    weights <span class="op">=</span> <span class="va">ate_weights</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = lalonde.formu, family = quasibinomial(link = "logit"), 
##     data = lalonde, weights = ate_weights)
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)
## (Intercept) -2.000e-01  1.977e+00  -0.101    0.919
## age          2.686e-02  8.513e-02   0.316    0.753
## I(age^2)    -4.695e-04  1.397e-03  -0.336    0.737
## educ        -6.326e-02  4.024e-01  -0.157    0.875
## I(educ^2)    3.510e-03  2.259e-02   0.155    0.877
## black       -3.695e-03  3.714e-01  -0.010    0.992
## hisp         2.232e-02  4.904e-01   0.046    0.964
## married     -8.664e-03  2.784e-01  -0.031    0.975
## nodegr       4.154e-02  3.889e-01   0.107    0.915
## re74         2.291e-05  7.493e-05   0.306    0.760
## I(re74^2)   -9.734e-10  2.337e-09  -0.416    0.677
## re75         5.001e-06  1.015e-04   0.049    0.961
## I(re75^2)   -3.543e-10  5.032e-09  -0.070    0.944
## u74          8.163e-02  4.449e-01   0.183    0.854
## u75         -4.153e-04  3.566e-01  -0.001    0.999
## 
## (Dispersion parameter for quasibinomial family taken to be 2.067727)
## 
##     Null deviance: 1232.6  on 444  degrees of freedom
## Residual deviance: 1231.9  on 430  degrees of freedom
## AIC: NA
## 
## Number of Fisher Scoring iterations: 4</code></pre>
</div>
<div id="estimate-ate" class="section level3" number="4.3.2">
<h3>
<span class="header-section-number">4.3.2</span> Estimate ATE<a class="anchor" aria-label="anchor" href="#estimate-ate"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">re78</span> <span class="op">~</span> <span class="va">treat</span>, </span>
<span>   data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>   weights <span class="op">=</span> <span class="va">ate_weights</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = re78 ~ treat, data = lalonde, weights = ate_weights)
## 
## Weighted Residuals:
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)     4556        450  10.125   &lt;2e-16 ***
## treat           1558        637   2.446   0.0148 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 9497 on 443 degrees of freedom
## Multiple R-squared:  0.01333,    Adjusted R-squared:  0.0111 
## F-statistic: 5.983 on 1 and 443 DF,  p-value: 0.01483</code></pre>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/treatment_effect.html">treatment_effect</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                      outcome <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span>,</span>
<span>                      weights <span class="op">=</span> <span class="va">ate_weights</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 1558.09</code></pre>
</div>
</div>
<div id="average-treatment-effect-among-the-treated-att-1" class="section level2" number="4.4">
<h2>
<span class="header-section-number">4.4</span> Average Treatment Effect Among the Treated (ATT)<a class="anchor" aria-label="anchor" href="#average-treatment-effect-among-the-treated-att-1"><i class="fas fa-link"></i></a>
</h2>
<p><span class="math display" id="eq:eqattw">\[\begin{equation}
\begin{aligned}
w_{ATT} = \frac{\pi_i Z_i}{\pi_i} + \frac{\pi_i (1 - Z_i)}{1 - \pi_i}
\end{aligned}
\tag{4.3}
\end{equation}\]</span></p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">att_weights</span> <span class="op">&lt;-</span> <span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/calculate_ps_weights.html">calculate_ps_weights</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                                         ps <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">lr_ps</span>, </span>
<span>                                         estimand <span class="op">=</span> <span class="st">'ATT'</span><span class="op">)</span></span></code></pre></div>
<div id="check-balance-with-att-weights" class="section level3" number="4.4.1">
<h3>
<span class="header-section-number">4.4.1</span> Check Balance with ATT Weights<a class="anchor" aria-label="anchor" href="#check-balance-with-att-weights"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">lalonde.formu</span>,</span>
<span>    data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>    family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">quasibinomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'logit'</span><span class="op">)</span>,</span>
<span>    weights <span class="op">=</span> <span class="va">att_weights</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = lalonde.formu, family = quasibinomial(link = "logit"), 
##     data = lalonde, weights = att_weights)
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)
## (Intercept)  1.122e-01  1.754e+00   0.064    0.949
## age          2.350e-02  8.362e-02   0.281    0.779
## I(age^2)    -4.382e-04  1.352e-03  -0.324    0.746
## educ        -1.279e-01  3.424e-01  -0.374    0.709
## I(educ^2)    7.725e-03  1.931e-02   0.400    0.689
## black       -5.090e-02  3.388e-01  -0.150    0.881
## hisp        -7.925e-02  5.202e-01  -0.152    0.879
## married     -2.667e-02  2.691e-01  -0.099    0.921
## nodegr       1.449e-01  3.623e-01   0.400    0.689
## re74         9.327e-06  7.444e-05   0.125    0.900
## I(re74^2)   -9.597e-11  2.521e-09  -0.038    0.970
## re75        -1.340e-05  9.575e-05  -0.140    0.889
## I(re75^2)    7.444e-10  4.817e-09   0.155    0.877
## u74         -6.362e-02  4.320e-01  -0.147    0.883
## u75          8.469e-02  3.390e-01   0.250    0.803
## 
## (Dispersion parameter for quasibinomial family taken to be 0.8614842)
## 
##     Null deviance: 513.54  on 444  degrees of freedom
## Residual deviance: 513.06  on 430  degrees of freedom
## AIC: NA
## 
## Number of Fisher Scoring iterations: 4</code></pre>
</div>
<div id="estimate-att" class="section level3" number="4.4.2">
<h3>
<span class="header-section-number">4.4.2</span> Estimate ATT<a class="anchor" aria-label="anchor" href="#estimate-att"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">re78</span> <span class="op">~</span> <span class="va">treat</span>, </span>
<span>   data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>   weights <span class="op">=</span> <span class="va">att_weights</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = re78 ~ treat, data = lalonde, weights = att_weights)
## 
## Weighted Residuals:
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   4557.4      454.2  10.033  &lt; 2e-16 ***
## treat         1791.7      642.8   2.787  0.00554 ** 
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 6186 on 443 degrees of freedom
## Multiple R-squared:  0.01724,    Adjusted R-squared:  0.01502 
## F-statistic:  7.77 on 1 and 443 DF,  p-value: 0.00554</code></pre>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/treatment_effect.html">treatment_effect</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                      outcome <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span>,</span>
<span>                      weights <span class="op">=</span> <span class="va">att_weights</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 1791.72</code></pre>
</div>
</div>
<div id="average-treatment-effect-among-the-control-atc-1" class="section level2" number="4.5">
<h2>
<span class="header-section-number">4.5</span> Average Treatment Effect Among the Control (ATC)<a class="anchor" aria-label="anchor" href="#average-treatment-effect-among-the-control-atc-1"><i class="fas fa-link"></i></a>
</h2>
<p><span class="math display" id="eq:eqatcw">\[\begin{equation}
\begin{aligned}
w_{ATC} = \frac{(1 - \pi_i) Z_i}{\pi_i} + \frac{(1 - e_i)(1 - Z_i)}{1 - \pi_i}
\end{aligned}
\tag{4.4}
\end{equation}\]</span></p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">atc_weights</span> <span class="op">&lt;-</span> <span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/calculate_ps_weights.html">calculate_ps_weights</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                                         ps <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">lr_ps</span>, </span>
<span>                                         estimand <span class="op">=</span> <span class="st">'ATC'</span><span class="op">)</span></span></code></pre></div>
<div id="check-balance-with-atc-weights" class="section level3" number="4.5.1">
<h3>
<span class="header-section-number">4.5.1</span> Check Balance with ATC Weights<a class="anchor" aria-label="anchor" href="#check-balance-with-atc-weights"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">lalonde.formu</span>,</span>
<span>    data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>    family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">quasibinomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'logit'</span><span class="op">)</span>,</span>
<span>    weights <span class="op">=</span> <span class="va">atc_weights</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = lalonde.formu, family = quasibinomial(link = "logit"), 
##     data = lalonde, weights = atc_weights)
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)
## (Intercept) -6.598e-01  2.390e+00  -0.276    0.783
## age          3.097e-02  8.728e-02   0.355    0.723
## I(age^2)    -5.201e-04  1.449e-03  -0.359    0.720
## educ         4.722e-02  4.975e-01   0.095    0.924
## I(educ^2)   -3.225e-03  2.766e-02  -0.117    0.907
## black        3.598e-02  4.033e-01   0.089    0.929
## hisp         7.912e-02  4.941e-01   0.160    0.873
## married      7.290e-03  2.868e-01   0.025    0.980
## nodegr      -7.488e-02  4.205e-01  -0.178    0.859
## re74         2.763e-05  7.658e-05   0.361    0.718
## I(re74^2)   -1.296e-09  2.319e-09  -0.559    0.577
## re75         2.037e-05  1.073e-04   0.190    0.849
## I(re75^2)   -1.341e-09  5.282e-09  -0.254    0.800
## u74          1.831e-01  4.577e-01   0.400    0.689
## u75         -7.234e-02  3.730e-01  -0.194    0.846
## 
## (Dispersion parameter for quasibinomial family taken to be 1.206136)
## 
##     Null deviance: 719.09  on 444  degrees of freedom
## Residual deviance: 717.84  on 430  degrees of freedom
## AIC: NA
## 
## Number of Fisher Scoring iterations: 4</code></pre>
</div>
<div id="estimate-atc" class="section level3" number="4.5.2">
<h3>
<span class="header-section-number">4.5.2</span> Estimate ATC<a class="anchor" aria-label="anchor" href="#estimate-atc"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">re78</span> <span class="op">~</span> <span class="va">treat</span>, </span>
<span>   data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>   weights <span class="op">=</span> <span class="va">atc_weights</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = re78 ~ treat, data = lalonde, weights = atc_weights)
## 
## Weighted Residuals:
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   4554.8      446.8  10.195   &lt;2e-16 ***
## treat         1391.0      632.6   2.199   0.0284 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 7204 on 443 degrees of freedom
## Multiple R-squared:  0.0108, Adjusted R-squared:  0.008564 
## F-statistic: 4.835 on 1 and 443 DF,  p-value: 0.0284</code></pre>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/treatment_effect.html">treatment_effect</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                      outcome <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span>,</span>
<span>                      weights <span class="op">=</span> <span class="va">atc_weights</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 1391.02</code></pre>
</div>
</div>
<div id="average-treatment-effect-among-the-evenly-matched-atm-1" class="section level2" number="4.6">
<h2>
<span class="header-section-number">4.6</span> Average Treatment Effect Among the Evenly Matched (ATM)<a class="anchor" aria-label="anchor" href="#average-treatment-effect-among-the-evenly-matched-atm-1"><i class="fas fa-link"></i></a>
</h2>
<p><span class="math display" id="eq:eqatmw">\[\begin{equation}
\begin{aligned}
w_{ATM} = \frac{min\{\pi_i, 1 - \pi_i\}}{Z_i \pi_i (1 - Z_i)(1 - \pi_i)}
\end{aligned}
\tag{4.5}
\end{equation}\]</span></p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">atm_weights</span> <span class="op">&lt;-</span> <span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/calculate_ps_weights.html">calculate_ps_weights</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                                         ps <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">lr_ps</span>, </span>
<span>                                         estimand <span class="op">=</span> <span class="st">'ATM'</span><span class="op">)</span></span></code></pre></div>
<div id="check-balance-with-atm-weights" class="section level3" number="4.6.1">
<h3>
<span class="header-section-number">4.6.1</span> Check Balance with ATM Weights<a class="anchor" aria-label="anchor" href="#check-balance-with-atm-weights"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">lalonde.formu</span>,</span>
<span>    data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>    family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">quasibinomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'logit'</span><span class="op">)</span>,</span>
<span>    weights <span class="op">=</span> <span class="va">atm_weights</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = lalonde.formu, family = quasibinomial(link = "logit"), 
##     data = lalonde, weights = atm_weights)
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)
## (Intercept)  1.657e-01  2.129e+00   0.078    0.938
## age         -2.418e-02  8.893e-02  -0.272    0.786
## I(age^2)     4.192e-04  1.465e-03   0.286    0.775
## educ         6.308e-02  4.304e-01   0.147    0.884
## I(educ^2)   -3.347e-03  2.420e-02  -0.138    0.890
## black        1.480e-02  3.577e-01   0.041    0.967
## hisp        -3.495e-02  5.203e-01  -0.067    0.946
## married     -3.486e-03  2.736e-01  -0.013    0.990
## nodegr      -4.659e-02  3.825e-01  -0.122    0.903
## re74        -2.333e-05  7.526e-05  -0.310    0.757
## I(re74^2)    8.298e-10  2.510e-09   0.331    0.741
## re75        -7.419e-06  9.758e-05  -0.076    0.939
## I(re75^2)    7.957e-10  4.775e-09   0.167    0.868
## u74         -6.630e-02  4.360e-01  -0.152    0.879
## u75         -3.051e-02  3.436e-01  -0.089    0.929
## 
## (Dispersion parameter for quasibinomial family taken to be 0.7850194)
## 
##     Null deviance: 467.94  on 444  degrees of freedom
## Residual deviance: 467.73  on 430  degrees of freedom
## AIC: NA
## 
## Number of Fisher Scoring iterations: 3</code></pre>
</div>
<div id="estimate-atm" class="section level3" number="4.6.2">
<h3>
<span class="header-section-number">4.6.2</span> Estimate ATM<a class="anchor" aria-label="anchor" href="#estimate-atm"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">re78</span> <span class="op">~</span> <span class="va">treat</span>, </span>
<span>   data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>   weights <span class="op">=</span> <span class="va">atm_weights</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = re78 ~ treat, data = lalonde, weights = atm_weights)
## 
## Weighted Residuals:
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   4504.6      459.8   9.797  &lt; 2e-16 ***
## treat         1707.7      648.8   2.632  0.00878 ** 
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 5960 on 443 degrees of freedom
## Multiple R-squared:  0.0154, Adjusted R-squared:  0.01318 
## F-statistic: 6.928 on 1 and 443 DF,  p-value: 0.008783</code></pre>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">psa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psa/man/treatment_effect.html">treatment_effect</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span>,</span>
<span>                      outcome <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">re78</span>,</span>
<span>                      weights <span class="op">=</span> <span class="va">atm_weights</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 1707.69</code></pre>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="chapter-matching.html"><span class="header-section-number">3</span> Matching</a></div>
<div class="next"><a href="chapter-sensitivity.html"><span class="header-section-number">5</span> Sensitivity Analysis</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>In this chapter</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#chapter-weighting"><span class="header-section-number">4</span> Weighting</a></li>
<li><a class="nav-link" href="#estimate-propensity-scores"><span class="header-section-number">4.1</span> Estimate Propensity Scores</a></li>
<li><a class="nav-link" href="#checking-balance-1"><span class="header-section-number">4.2</span> Checking Balance</a></li>
<li>
<a class="nav-link" href="#average-treatment-effect-ate-1"><span class="header-section-number">4.3</span> Average Treatment Effect (ATE)</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#check-balance-with-ate-weights"><span class="header-section-number">4.3.1</span> Check Balance with ATE Weights</a></li>
<li><a class="nav-link" href="#estimate-ate"><span class="header-section-number">4.3.2</span> Estimate ATE</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#average-treatment-effect-among-the-treated-att-1"><span class="header-section-number">4.4</span> Average Treatment Effect Among the Treated (ATT)</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#check-balance-with-att-weights"><span class="header-section-number">4.4.1</span> Check Balance with ATT Weights</a></li>
<li><a class="nav-link" href="#estimate-att"><span class="header-section-number">4.4.2</span> Estimate ATT</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#average-treatment-effect-among-the-control-atc-1"><span class="header-section-number">4.5</span> Average Treatment Effect Among the Control (ATC)</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#check-balance-with-atc-weights"><span class="header-section-number">4.5.1</span> Check Balance with ATC Weights</a></li>
<li><a class="nav-link" href="#estimate-atc"><span class="header-section-number">4.5.2</span> Estimate ATC</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#average-treatment-effect-among-the-evenly-matched-atm-1"><span class="header-section-number">4.6</span> Average Treatment Effect Among the Evenly Matched (ATM)</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#check-balance-with-atm-weights"><span class="header-section-number">4.6.1</span> Check Balance with ATM Weights</a></li>
<li><a class="nav-link" href="#estimate-atm"><span class="header-section-number">4.6.2</span> Estimate ATM</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/jbryer/psa/blob/master/book/04-Weighting.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/jbryer/psa/edit/master/book/04-Weighting.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
      <div class="book-extra">
        <ul class="list-unstyled">
<li><a href="https://github.com/jbryer/psa/actions/workflows/bookdown.yaml"><img src="https://github.com/jbryer/psa/actions/workflows/bookdown.yaml/badge.svg" alt="Bookdown Status"></a></li>
          <li><a href="https://www.repostatus.org/#wip"><img src="https://www.repostatus.org/badges/latest/wip.svg" border="0" alt="Project Status: WIP - Initial development is in progress, but there has not yet been a stable, usable release suitable for the public."></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Applied Propensity Score Analysis with R</strong>" was written by Jason Bryer, Ph.D.. It was last built on 2023-11-13.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
